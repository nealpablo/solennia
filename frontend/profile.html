<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/style.css" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solennia — My Profile</title>
  <meta name="theme-color" content="#e8ddae" />

  <style>
    .panel { background:#ece8e1; border:1px solid #d9d6cf; border-radius:12px; }
    .btn-brown { background:#7a5d47; color:#fff; border-radius:8px; padding:.55rem 1rem; }
    .btn-brown:hover { opacity:.9; }
    .btn-ghost { background:#e0d6c6; color:#3b2f25; border-radius:8px; padding:.55rem 1rem; }

    /* Avatar Modal */
    #avatarModalBg {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      display: none; justify-content: center; align-items: center;
      z-index: 9999;
    }
    #avatarModal {
      background:#f6f0e8;
      padding: 1.5rem;
      border-radius: 16px;
      width: 90%; max-width: 420px;
      border: 1px solid #c9bda4;
      box-shadow: 0 4px 14px rgba(0,0,0,.1);
    }
  </style>
</head>

<body class="font-[Cinzel] text-[#1c1b1a] bg-[#f6f0e8]">
  <div data-include="/partials/header.html"></div>

  <main class="pb-24">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="mt-6 text-xl md:text-2xl font-semibold tracking-wide">PROFILE</h2>

      <!-- PROFILE AVATAR -->
      <div class="flex flex-col items-center text-center space-y-4">

        <div id="avatarContainer"
             style="cursor:pointer; width:112px; height:112px; border:2px solid #000; border-radius:9999px; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#fff;">
          <img id="profileAvatar" style="width:100%; height:100%; object-fit:cover; display:none;" />
          <svg id="profileAvatarFallback" viewBox="0 0 24 24" style="width:48px; height:48px; color:#1c1b1a;">
            <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V21h18v-1.5C21 16.5 17 14 12 14Z"/>
          </svg>
        </div>

        <div class="text-sm">
          <span class="font-semibold uppercase tracking-wide">Name :</span>
          <span id="profileName" class="ml-1">Guest</span>
        </div>

        <a id="profileDashboardBtn" href="#" class="btn-ghost inline-block">View Dashboard</a>
      </div>

      <!-- Role-based dashboard button -->
      <script>
        (function() {
          const btn  = document.getElementById('profileDashboardBtn');
          const role = parseInt(localStorage.getItem('solennia_role') || '0');

          if (role === 2) {
            btn.textContent = 'Admin Panel';
            btn.href = '/adminpanel.html';
          } else if (role === 1) {
            btn.textContent = 'Manage Dashboard';
            btn.href = '/vendordashboard.html';
          } else {
            btn.textContent = 'View Dashboard';
            btn.href = '#';
          }
        })();
      </script>

      <!-- FAVORITES -->
      <h2 class="mt-10 text-xl md:text-2xl font-semibold tracking-wide">FAVORITES</h2>

      <section class="mt-3 panel p-4 md:p-6">
        <article class="rounded-xl border border-[#ded7c9] overflow-hidden bg-[#f5f0ea] mb-4">
          <img src="/images/gallery1.jpg" class="fav-img">
        </article>

        <article class="rounded-xl border border-[#ded7c9] overflow-hidden bg-[#f5f0ea]">
          <img src="/images/gallery2.jpg" class="fav-img">
        </article>

        <div class="mt-6 flex justify-center">
          <button class="btn-brown">Compare Favorites</button>
        </div>
      </section>

      <!-- JOIN AS A VENDOR -->
      <section class="mt-10 text-center mb-16">
        <button id="joinVendorBtn" class="btn-brown">Join as a Vendor</button>
      </section>

    </div>
  </main>

  <div data-include="/partials/footer.html"></div>
  <div data-include="/partials/modals.html"></div>

  <!-- AVATAR MODAL -->
  <div id="avatarModalBg">
    <div id="avatarModal">
      <h2 class="text-lg font-semibold mb-3">Update Profile Picture</h2>

      <form id="avatarForm">
        <input type="file" name="avatar" accept="image/*" required
               class="border border-gray-400 rounded-lg p-2 w-full bg-white">

        <button type="submit" class="btn-brown w-full mt-4">Upload</button>
      </form>

      <button id="closeAvatarModal"
              class="btn-ghost w-full mt-3">Cancel</button>
    </div>
  </div>

  <script type="module" src="/src/app.js"></script>


  <!-- FULL PROFILE + VENDOR LOGIC -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {

    const token = localStorage.getItem("solennia_token");
    const joinVendorBtn = document.getElementById("joinVendorBtn");

    /* ---------------------------------------------------------
       LOAD PROFILE INFO
    ---------------------------------------------------------- */
    if (token) {
      const me = await fetch("/api/auth/me", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(r => r.json()).catch(() => null);

      if (me?.user) {
        const name = `${me.user.first_name || ""} ${me.user.last_name || ""}`.trim();
        document.getElementById("profileName").textContent = name;

        if (me.user.avatar) {
          profileAvatar.src = me.user.avatar;
          profileAvatar.style.display = "block";
          profileAvatarFallback.style.display = "none";
        }

        // store role
        localStorage.setItem("solennia_role", me.user.role ?? 0);
      }
    }

    const role = parseInt(localStorage.getItem("solennia_role") || "0");

    /* ---------------------------------------------------------
       FIX 1 — HIDE BUTTON FOR VENDOR & ADMIN
    ---------------------------------------------------------- */
    if (role === 1 || role === 2) {
      joinVendorBtn.style.display = "none";
    }

    /* ---------------------------------------------------------
       FIX 2 — CHECK APPLICATION STATUS FOR NORMAL USER (role 0)
    ---------------------------------------------------------- */
    if (token && role === 0) {
      try {
        const res = await fetch("/api/vendor/status", {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (res.ok) {
          const json = await res.json();
          if (json.status === "pending") {
            joinVendorBtn.textContent = "Vendor Application Pending";
            joinVendorBtn.disabled = true;
            joinVendorBtn.classList.add("opacity-50");
          }
        }
      } catch (err) {
        console.warn("Status check failed", err);
      }
    }

    /* ---------------------------------------------------------
       FIX 3 — JOIN BUTTON ACTION
    ---------------------------------------------------------- */
    joinVendorBtn.addEventListener("click", () => {
      if (!token) return alert("Please login first.");

      if (role !== 0) {
        return alert("You cannot apply as vendor.");
      }

      // open vendor modal from partials
      const modal = document.getElementById("vendorTerms");
      if (modal) modal.classList.remove("hidden");
    });

    /* ---------------------------------------------------------
       AVATAR MODAL
    ---------------------------------------------------------- */
    const avatarModalBg   = document.getElementById("avatarModalBg");
    const avatarForm      = document.getElementById("avatarForm");
    const avatarContainer = document.getElementById("avatarContainer");
    const closeAvatarModal= document.getElementById("closeAvatarModal");

    avatarContainer.onclick = () => {
      if (!token) return alert("Please log in first.");
      avatarModalBg.style.display = "flex";
    };

    closeAvatarModal.onclick = () => avatarModalBg.style.display = "none";

    avatarForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(avatarForm);

      const res = await fetch("/api/user/update", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd
      });

      const json = await res.json().catch(()=>({}));

      if (!res.ok) return alert(json.error || "Avatar update failed.");

      // refresh profile
      const me = await fetch("/api/auth/me", {
        headers: { Authorization: `Bearer ${token}` }
      }).then(r=>r.json()).catch(()=>null);

      if (me?.user?.avatar) {
        profileAvatar.src = me.user.avatar;
        profileAvatar.style.display = "block";
        profileAvatarFallback.style.display = "none";
        localStorage.setItem("solennia_profile", JSON.stringify(me.user));
      }

      avatarForm.reset();
      avatarModalBg.style.display = "none";
    });

  });
  </script>

  <script>
document.addEventListener("DOMContentLoaded", () => {

  const token = localStorage.getItem("solennia_token");

  // MODALS
  const vendorTerms       = document.getElementById("vendorTerms");
  const vendorBackground  = document.getElementById("vendorBackground");
  const vendorMedia       = document.getElementById("vendorMedia");

  const agreeTermsBtn     = document.getElementById("agreeTerms");
  const toMediaBtn        = document.getElementById("toMedia");
  const submitVendorBtn   = document.getElementById("submitVendor");

  const vendorForm1       = document.getElementById("vendorForm1");
  const vendorForm2       = document.getElementById("vendorForm2");

  // X buttons
  document.querySelectorAll("[data-closevendor]").forEach(btn => {
    btn.addEventListener("click", () => {
      vendorTerms.classList.add("hidden");
      vendorBackground.classList.add("hidden");
      vendorMedia.classList.add("hidden");
    });
  });

  // Join as vendor button
  document.getElementById("joinVendorBtn").addEventListener("click", () => {
    if (!token) { alert("Please log in first."); return; }
    vendorTerms.classList.remove("hidden");
  });

  // Step 1 → Step 2
  agreeTermsBtn.addEventListener("click", () => {
    vendorTerms.classList.add("hidden");
    vendorBackground.classList.remove("hidden");
  });

  // Step 2 → Step 3
  toMediaBtn.addEventListener("click", () => {
    if (!vendorForm1.checkValidity()) {
      vendorForm1.reportValidity();
      return;
    }
    vendorBackground.classList.add("hidden");
    vendorMedia.classList.remove("hidden");
  });

  // Final submit
  submitVendorBtn.addEventListener("click", async (e) => {
    e.preventDefault();

    if (!vendorForm2.checkValidity()) {
      vendorForm2.reportValidity();
      return;
    }

    const fd = new FormData();

    // FORM1
    fd.append("business_name", vendorForm1.business_name.value);
    fd.append("category", vendorForm1.category.value);
    fd.append("address", vendorForm1.address.value);

    // FORM2
    fd.append("description", vendorForm2.description.value);
    fd.append("pricing", vendorForm2.pricing.value);

    fd.append("permits", vendorForm2.permits.files[0]);
    fd.append("gov_id", vendorForm2.gov_id.files[0]);
    fd.append("portfolio", vendorForm2.portfolio.files[0]);

    try {
      const res = await fetch("/api/vendor/apply", {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd
      });
      const json = await res.json();

      if (!res.ok) throw new Error(json.error || "Application failed");

      alert("Vendor application submitted!");
      vendorMedia.classList.add("hidden");

    } catch (err) {
      console.error(err);
      alert(err.message);
    }
  });

});
</script>


</body>
</html>
