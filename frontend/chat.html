<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Solennia — Messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#e8ddae" />
  <link rel="stylesheet" href="/src/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background:#f6f0e8;
      font-family:"Cinzel",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#1c1b1a;
    }
    main { flex:1 0 auto; }

    .chat-shell {
      max-width: 100%;
      height: calc(100vh - 4rem - 7rem);
      min-height: 480px;
      margin: 0;
      display: grid;
      grid-template-columns: 280px 1fr;
      background:#f6f0e8;
      border-top:1px solid #d4c9b2;
    }
    .chat-sidebar {
      background:#f1e4c7;
      border-right:1px solid #d4c9b2;
      display:flex;
      flex-direction:column;
    }
    .chat-sidebar-header {
      padding:0.75rem 0.75rem 0.35rem;
      font-size:0.75rem;
      letter-spacing:0.2em;
      text-transform:uppercase;
    }
    .chat-contact-list {
      flex:1;
      overflow-y:auto;
      padding:0.25rem 0;
    }
    .chat-contact {
      display:flex;
      align-items:center;
      gap:0.5rem;
      padding:0.55rem 0.75rem;
      cursor:pointer;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .chat-contact:hover {
      background:rgba(0,0,0,0.04);
    }
    .chat-contact.active {
      background:#e0d5b8;
    }
    .chat-contact-avatar {
      width:2.5rem;
      height:2.5rem;
      border-radius:9999px;
      overflow:hidden;
      background:#fdfaf4;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid #1c1b1a;
      font-size:0.8rem;
    }
    .chat-contact-main {
      flex:1;
      font-size:0.85rem;
    }
    .chat-contact-name {
      letter-spacing:0.12em;
      text-transform:uppercase;
      line-height:1.2;
      font-weight:600;
    }
    .chat-contact-status {
      font-size:0.7rem;
      color:#555;
    }

    .chat-main {
      display:flex;
      flex-direction:column;
      background:#f6f0e8;
    }
    .chat-main-header {
      height:3rem;
      background:#dedede;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 1rem;
      font-size:0.8rem;
      letter-spacing:0.15em;
      text-transform:uppercase;
      gap: 1rem;
    }
    .chat-main-body {
      flex:1;
      overflow-y:auto;
      padding:1rem;
      position:relative;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3));
    }
    .chat-timestamp {
      font-size:0.65rem;
      text-align:center;
      color:#777;
      margin:0.75rem 0;
    }
    .chat-message {
      max-width:72%;
      padding:0.6rem 0.9rem;
      border-radius:1rem;
      font-size:0.86rem;
      line-height:1.35;
      margin-bottom:0.5rem;
      word-break: break-word;
    }
    .chat-message.me {
      margin-left:auto;
      background:#e0d5b8;
    }
    .chat-message.them {
      margin-right:auto;
      background:#fdfaf4;
    }
    .chat-meta {
      font-size:0.65rem;
      color:#666;
      margin-top:0.25rem;
      text-align: right;
    }
    .chat-input-bar {
      border-top:1px solid #d4c9b2;
      padding:0.6rem 0.8rem;
      background:#f6f0e8;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .chat-input {
      flex:1;
      border-radius:9999px;
      border:1px solid #c9bd9f;
      padding:0.55rem 0.9rem;
      font-size:0.9rem;
      background:#fdfaf4;
    }
    .chat-send-btn {
      border-radius:9999px;
      border:1px solid #1c1b1a;
      padding:0.45rem 1rem;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.12em;
      background:#f5efe5;
      cursor:pointer;
    }

    .empty-note {
      text-align:center;
      color:#6b6b6b;
      padding:2rem;
    }

    @media (max-width: 900px) {
      .chat-shell {
        grid-template-columns: 1fr;
      }
      .chat-sidebar {
        display:none;
      }
    }
  </style>
</head>
<body>
  <div data-include="/partials/header.html"></div>

  <main>
    <section class="chat-shell" role="main" aria-label="Chat interface">
      <!-- CONTACT LIST -->
      <aside class="chat-sidebar" aria-label="Contacts">
        <div class="chat-sidebar-header">Conversations</div>
        <div id="chatContacts" class="chat-contact-list" role="list">
          <!-- contacts inserted here -->
        </div>
      </aside>

      <!-- CHAT MAIN -->
      <section class="chat-main" aria-live="polite">
        <header class="chat-main-header">
          <div>
            <div id="chatActiveName">Select a contact</div>
            <div id="chatActiveStatus" style="font-size:.75rem;color:#444;"></div>
          </div>
          <div id="chatActions" style="display:flex;gap:.5rem;align-items:center;">
            <div id="connectedStatus" style="font-size:.75rem;color:#444;"></div>
          </div>
        </header>

        <div id="chatMessages" class="chat-main-body" aria-live="polite" tabindex="0">
          <p id="chatEmpty" class="chat-timestamp">
            Choose a vendor or user on the left to start chatting.
          </p>
        </div>

        <footer class="chat-input-bar">
          <input id="chatInput" class="chat-input" type="text" placeholder="Type…" aria-label="Message input"/>
          <button id="chatSend" class="chat-send-btn">Send</button>
        </footer>
      </section>
    </section>
  </main>

  <div data-include="/partials/footer.html"></div>
  <div data-include="/partials/modals.html"></div>

  <script type="module" src="/src/app.js"></script>


  <!-- firebase chat helper module (make sure file exists at /src/firebase-chat.js) -->
  <script type="module">
    import {
      initChat,
      currentUserUid,
      listThreadsForCurrentUser,
      openThreadByOtherUid,
      sendMessageToThread,
      onThreadMessages
    } from '/src/firebase-chat.js';

    // Boot Firebase chat
    const params = new URLSearchParams(location.search);
    const toParam = params.get('to'); // expected: Firebase UID of other party (preferred)

    // DOM
    const contactsEl = document.getElementById('chatContacts');
    const msgsEl     = document.getElementById('chatMessages');
    const emptyEl    = document.getElementById('chatEmpty');
    const inputEl    = document.getElementById('chatInput');
    const sendBtn    = document.getElementById('chatSend');
    const activeName = document.getElementById('chatActiveName');
    const activeStatus = document.getElementById('chatActiveStatus');
    const connectedStatus = document.getElementById('connectedStatus');

    let currentThreadId = null;
    let currentOtherUid = null;
    let meUid = null;

    async function bootstrap() {
      try {
        await initChat(); // awaits auth ready
        meUid = currentUserUid();
        connectedStatus.textContent = meUid ? 'Connected' : 'Not signed in';

        // populate contact list from existing threads
        const threads = await listThreadsForCurrentUser();
        renderContacts(threads);

        // if ?to= passed, open thread with that uid (attempt)
        if (toParam) {
          // If param is a firebase uid, open directly. If it looks numeric (mysql id),
          // the chat module will attempt to look up firebase_uid via backend (if available).
          openThreadByOtherUid(toParam, threadInfo => {
            if (!threadInfo) {
              showEmptyNote('Unable to start chat — vendor not linked to Firebase.');
              return;
            }
            openThreadUI(threadInfo.threadId, threadInfo.otherUid, threadInfo.otherMeta);
          });
        }
      } catch (e) {
        console.error('Chat init error', e);
        showEmptyNote('Failed to initialize chat. Check console.');
      }
    }

    function showEmptyNote(text) {
      msgsEl.innerHTML = `<div class="empty-note">${text}</div>`;
    }

    function renderContacts(threads) {
      contactsEl.innerHTML = '';
      if (!threads || threads.length === 0) {
        contactsEl.innerHTML = '<div class="px-3 py-4 text-[0.8rem] text-gray-600">No conversations yet.</div>';
        return;
      }
      threads.forEach(t => {
        const other = t.otherUid;
        const name = t.otherName || (other ? other.slice(0,8) : 'Unknown');
        const div = document.createElement('button');
        div.className = 'chat-contact';
        div.dataset.thread = t.threadId;
        div.innerHTML = `
          <div class="chat-contact-avatar">${(t.otherName || other || 'U')[0] || 'U'}</div>
          <div class="chat-contact-main">
            <div class="chat-contact-name">${name}</div>
            <div class="chat-contact-status">${t.lastMessageSnippet || ''}</div>
          </div>
        `;
        div.addEventListener('click', () => {
          // select
          document.querySelectorAll('.chat-contact').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
          openThreadUI(t.threadId, t.otherUid, { displayName: t.otherName });
        });
        contactsEl.appendChild(div);
      });
    }

    function openThreadUI(threadId, otherUid, otherMeta = {}) {
      currentThreadId = threadId;
      currentOtherUid = otherUid;
      activeName.textContent = otherMeta.displayName || otherMeta.business_name || (otherUid || 'Chat');
      activeStatus.textContent = (otherMeta.role ? (otherMeta.role === 1 ? 'Vendor' : (otherMeta.role === 2 ? 'Admin' : 'User')) : '');

      msgsEl.innerHTML = '';
      // listen live
      onThreadMessages(threadId, msg => {
        appendMessage(msg);
      });
    }

    function appendMessage(msg) {
      const bubble = document.createElement('div');
      const mine = msg.senderUid === meUid;
      bubble.className = 'chat-message ' + (mine ? 'me' : 'them');
      bubble.innerHTML = `<div>${escapeHtml(msg.text)}</div>
        <div class="chat-meta">${new Date(msg.ts || Date.now()).toLocaleString()}</div>`;
      msgsEl.appendChild(bubble);
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function escapeHtml(s = '') {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    async function handleSend() {
      const text = (inputEl.value || '').trim();
      if (!text || !currentThreadId) return;
      inputEl.value = '';
      try {
        await sendMessageToThread(currentThreadId, { text });
      } catch (e) {
        console.error('send failed', e);
        showEmptyNote('Failed to send message.');
      }
    }

    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    bootstrap();
  </script>
</body>
</html>
