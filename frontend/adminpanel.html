<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solennia — Admin Control Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/src/style.css" />
  <style>
    body { font-family:'Cinzel',serif; background:#f6f0e8; color:#1c1b1a; min-height:100vh; display:flex; flex-direction:column; }
    main { flex:1; padding:2rem; }
    .table-container { overflow-x:auto; background:#fff; border:1px solid #d1d5db; border-radius:1rem; padding:1rem; box-shadow:0 2px 4px rgba(0,0,0,.1); margin-bottom:2rem; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:.75rem; text-align:left; border-bottom:1px solid #e5e5e5; vertical-align:middle; }
    th { background:#e8ddae; color:#1c1b1a; }
    button { border:2px solid transparent; padding:.4rem .8rem; border-radius:.5rem; cursor:pointer; font-weight:600; transition:all .2s; }
    button.approve-btn { background:#7a5d47; color:#fff; border-color:#5a4333; }
    button.approve-btn:hover { background:#6a503d; }
    button.deny-btn { background:#b91c1c; color:#fff; border-color:#7f1414; }
    button.deny-btn:hover { background:#991b1b; }
    button.muted { background:#e5e7eb; color:#6b7280; border-color:#d1d5db; cursor:not-allowed; }
  </style>
</head>
<body>
  <!-- Shared header -->
  <div data-include="/partials/header.html"></div>

  <!-- Patch the shared header ONLY on this page:
       - Brand → plain text "Solennia Admin Panel" (not clickable, not bold)
       - Remove ONLY the "Admin Panel" item from profile dropdown (keep elsewhere)
       - Ensure Logout is normal font-weight -->
  <script>
    (function () {
      function patchHeader() {
        const nav = document.querySelector('header nav');
        if (!nav) return false;

        // 1) Brand: replace clickable SOLENNIA link with plain text "Solennia Admin Panel"
        const brandLink = nav.querySelector('a[href="/index.html"]');
        if (brandLink) {
          const span = document.createElement('span');
          span.textContent = 'Solennia Admin Panel';
          span.className = 'text-xl tracking-wide font-normal cursor-default';
          brandLink.replaceWith(span);
        }

        // 2) Remove ONLY the "Admin Panel" item in the dropdown on this page
        const menuAdmin = nav.querySelector('#menuAdmin');
        if (menuAdmin) {
          menuAdmin.remove(); // hide/remove here; keeps it on other pages
        }

        // 3) Ensure Logout is normal weight on this page
        const menuLogout = nav.querySelector('#menuLogout');
        if (menuLogout) {
          menuLogout.style.fontWeight = '400';
        }
        return true;
      }

      // The header is injected asynchronously; retry briefly until it exists.
      let tries = 0;
      const maxTries = 50; // ~5s total
      const iv = setInterval(() => {
        tries++;
        if (patchHeader() || tries >= maxTries) clearInterval(iv);
      }, 100);

      // Also patch once on DOM ready just in case
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(patchHeader, 0));
      } else {
        setTimeout(patchHeader, 0);
      }
    })();
  </script>

  <main class="max-w-7xl mx-auto w-full">
    <h2 class="text-2xl font-semibold mb-6 mt-2">Vendor Applications</h2>
    <div id="vendorApplications" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Applicant</th>
            <th>Business Name</th>
            <th>Category</th>
            <th>Address</th>
            <th>Pricing</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="vendorTableBody">
          <tr><td colspan="6" class="text-center py-4">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <h2 class="text-2xl font-semibold mb-6">User Management</h2>
    <div id="usersSection" class="table-container">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Email</th>
            <th>Username</th>
            <th>Role</th>
            <th style="min-width:240px;">Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <tr><td colspan="5" class="text-center py-4">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <h2 class="text-2xl font-semibold mb-6">User Feedback</h2>
    <div id="feedbackSection" class="table-container">
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Message</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="feedbackTableBody">
          <tr><td colspan="3" class="text-center py-4">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <!-- Shared footer + modals -->
  <div data-include="/partials/footer.html"></div>
  <div data-include="/partials/modals.html"></div>

  <!-- Loader (injects header/footer/modals & wires interactions) -->
  <script type="module" src="/src/partials-loader.js"></script>

  <script>
    const API = import.meta?.env?.VITE_API_BASE || '/api';
    const token = localStorage.getItem('solennia_token');
    const headers = {'Content-Type':'application/json', ...(token?{Authorization:`Bearer ${token}`}:{})};

    function roleLabel(r){return r===2?'Admin':r===1?'Supplier':'Client';}
    async function safeParse(res){const ct=res.headers.get('content-type')||''; if(ct.includes('application/json'))return res.json(); const t=await res.text(); throw new Error(t||`${res.status} ${res.statusText}`);}

    async function loadVendorApplications(){
      const body=document.getElementById('vendorTableBody');
      try{
        const res=await fetch(`${API}/admin/vendor-applications`,{headers});
        const json=await res.json();
        if(!json.success) throw new Error(json.error||'Failed to load');
        const apps=json.applications||[];
        if(!apps.length){ body.innerHTML='<tr><td colspan="6" class="text-center py-4">No pending applications</td></tr>'; return;}
        body.innerHTML=apps.map(a=>`
          <tr>
            <td>${(a.first_name||'')+' '+(a.last_name||'')}</td>
            <td>${a.business_name||'-'}</td>
            <td>${a.category||'-'}</td>
            <td>${a.address||'-'}</td>
            <td>${a.pricing||'-'}</td>
            <td>
              <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                <button class="approve-btn" onclick="handleDecision(${a.id}, 'approve')">Approve</button>
                <button class="deny-btn" style="border:2px solid #7f1414" onclick="handleDecision(${a.id}, 'deny')">Deny</button>
              </div>
            </td>
          </tr>`).join('');
      }catch(err){ body.innerHTML=`<tr><td colspan="6" class="text-center" style="color:#b91c1c;">Error loading applications</td></tr>`; }
    }
    async function handleDecision(id, action){
      if(!confirm(`Are you sure you want to ${action} this vendor?`)) return;
      try{
        const res=await fetch(`${API}/admin/vendor-application/decision`,{method:'POST',headers,body:JSON.stringify({id,action})});
        const json=await safeParse(res);
        if(!json.success) throw new Error(json.error||'Failed');
        alert(json.message); loadVendorApplications();
      }catch(err){ alert('Error: '+err.message); }
    }

    async function changeRole(user_id, role){
      try{
        const res=await fetch(`${API}/admin/users/role`,{method:'POST',headers,body:JSON.stringify({user_id,role})});
        const json=await safeParse(res);
        if(!json.success) throw new Error(json.error||'Failed');
        loadUsers();
      }catch(err){ alert('Error: '+err.message); }
    }
    function renderUserActions(u){
      const promoteBtn=(u.role<2)?`<button class="approve-btn" onclick="if(confirm('Promote to ${roleLabel(u.role+1)}?')) changeRole(${u.id}, ${u.role+1})">Promote</button>`:`<span style="color:#6b7280;">Max role</span>`;
      const demoteBtn=(u.role===2)?`<button class="muted" disabled title="Admins cannot be demoted">Demote</button>`:(u.role===1)?`<button class="deny-btn" onclick="if(confirm('Demote Supplier to Client?')) changeRole(${u.id}, 0)">Demote</button>`:`<button class="muted" disabled title="Client is the lowest role">Demote</button>`;
      return `<div style="display:flex;gap:.5rem;flex-wrap:wrap;">${promoteBtn}${demoteBtn}</div>`;
    }
    async function loadUsers(){
      const body=document.getElementById('userTableBody');
      try{
        const res=await fetch(`${API}/admin/users`,{headers});
        const json=await res.json();
        if(!json.success) throw new Error(json.error||'Failed');
        const users=json.users||[];
        if(!users.length){ body.innerHTML='<tr><td colspan="5" class="text-center py-4">No users found</td></tr>'; return;}
        body.innerHTML=users.map(u=>`
          <tr>
            <td>${(u.first_name||'')+' '+(u.last_name||'')}</td>
            <td>${u.email||''}</td>
            <td>${u.username||''}</td>
            <td>${roleLabel(u.role)}</td>
            <td>${renderUserActions(u)}</td>
          </tr>`).join('');
      }catch(err){ body.innerHTML=`<tr><td colspan="5" class="text-center" style="color:#b91c1c;">Error loading users</td></tr>`; }
    }
    async function loadFeedbacks(){
      const body=document.getElementById('feedbackTableBody');
      try{
        const res=await fetch(`${API}/admin/feedbacks`,{headers});
        const json=await res.json();
        if(!json.success) throw new Error(json.error||'Failed');
        const list=json.feedbacks||[];
        if(!list.length){ body.innerHTML='<tr><td colspan="3" class="text-center py-4">No feedback yet</td></tr>'; return;}
        body.innerHTML=list.map(f=>`
          <tr>
            <td>${(f.first_name||'')+' '+(f.last_name||'')}</td>
            <td>${f.message||''}</td>
            <td>${f.created_at?new Date(f.created_at).toLocaleString():''}</td>
          </tr>`).join('');
      }catch(err){ body.innerHTML=`<tr><td colspan="3" class="text-center" style="color:#b91c1c;">Error loading feedback</td></tr>`; }
    }

    loadVendorApplications(); loadUsers(); loadFeedbacks();
    window.handleDecision=handleDecision; window.changeRole=changeRole;
  </script>
</body>
</html>
